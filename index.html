<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A 2D survival game">
    <meta name="author" content="mcjdh">
    <meta name="theme-color" content="#111111">
    <title>Galactic Ring Cannon</title>
    <link rel="preload" href="assets/css/styles.css" as="style">
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÆ</text></svg>">
</head>
<body>
    <div id="loading-screen">
        <h1>Galactic Ring Cannon</h1>
        <p>Prepare for battle...</p>
        <div id="loading-bar">
            <div id="loading-progress"></div>
        </div>
        <p id="loading-tip">Tip: Use WASD or Arrow Keys to move</p>
    </div>
    
    <!-- Main Menu: Title / Mode Selection -->
    <div id="main-menu" class="hidden">
        <h1 id="menu-title">Galactic Ring Cannon</h1>
        <div id="star-menu-display">‚≠ê 0</div>
        <p id="menu-subtitle">Select Mode:</p>
        <button id="btn-normal" class="menu-button">Normal Mode</button>
        <button id="btn-endless" class="menu-button">Endless Mode</button>
        <button id="btn-settings" class="menu-button">Settings</button>
        <button id="btn-shop" class="menu-button">Star Vendor</button>
        <button id="btn-achievements" class="menu-button">Achievements</button>
    </div>
    
    <div id="game-container" class="hidden">
        <canvas id="game-canvas"></canvas>
        <div id="level-up-container" class="hidden">
            <h2>Level Up!</h2>
            <p class="shortcut-hint">Press 1, 2, or 3 to select an upgrade</p>
            <div id="upgrade-options"></div>
        </div>
        <div id="ui-container">
            <div id="health-bar"></div>
            <div id="xp-bar"></div>
            <div id="level-display">Level: 1</div>
            <!-- Combo progress bar -->
            <div id="combo-container">
                <div id="combo-fill"></div>
            </div>
            <!-- Combo count display -->
            <div id="combo-text">0</div>
        </div>
        <button id="pause-button" class="control-button">‚è∏Ô∏è</button>
        <div id="controls-info">P or ESC = Pause | SPACE = Dodge</div>
        
        <!-- Add minimap -->
        <div id="minimap-container">
            <canvas id="minimap"></canvas>
        </div>
        
        <!-- Add skill cooldown indicator -->
        <div id="skill-container">
            <div id="dodge-skill" class="skill">
                <div class="skill-icon">üí®</div>
                <div class="skill-cooldown"></div>
                <div class="skill-key">SPACE</div>
            </div>
        </div>
    </div>
    
    <div id="pause-menu" class="hidden">
        <div class="pause-content">
            <h2>Game Paused</h2>
        <button id="resume-button" class="menu-button">Resume</button>
        <button id="restart-button-pause" class="menu-button">Restart</button>
        <button id="return-button-pause" class="menu-button">Main Menu</button>
            <h3>Controls:</h3>
            <p>WASD or Arrow Keys = Move</p>
            <p>P or ESC = Pause Game</p>
        <p>M = Toggle Sound</p>
        <p>L = Toggle Low Quality</p>
        </div>
    </div>
    
    <!-- Shop Panel -->
    <div id="shop-panel" class="hidden">
        <div class="settings-content">
            <h2>Star Vendor</h2>
            <!-- Show current star balance -->
            <div id="vendor-star-display">‚≠ê 0</div>
            <!-- List of purchasable upgrades -->
            <div id="shop-items"></div>
            <button id="shop-close" class="menu-button">Close</button>
        </div>
    </div>
    <!-- Settings Panel -->
    <div id="settings-panel" class="hidden">
        <div class="settings-content">
            <h2>Settings</h2>
            <div class="setting-item">
                <label for="mute-checkbox">Mute</label>
                <input type="checkbox" id="mute-checkbox">
            </div>
            <div class="setting-item">
                <label for="volume-range">Volume</label>
                <input type="range" id="volume-range" min="0" max="1" step="0.01">
            </div>
            <div class="setting-item">
                <label for="lowquality-checkbox">Low Quality</label>
                <input type="checkbox" id="lowquality-checkbox">
            </div>
            <div class="setting-item">
                <label for="difficulty-select">Difficulty</label>
                <select id="difficulty-select">
                    <option value="easy">Easy</option>
                    <option value="normal">Normal</option>
                    <option value="hard">Hard</option>
                </select>
            </div>
            <button id="settings-close" class="menu-button">Apply & Close</button>
        </div>
    </div>
    
    <!-- Add Achievements Panel -->
    <div id="achievements-panel" class="hidden">
        <div class="settings-content">
            <h2>Achievements</h2>
            <div id="achievements-progress">
                <span id="achievements-count">0/0</span> Achievements Unlocked
            </div>
            <div id="achievements-list"></div>
            <button id="achievements-close" class="menu-button">Close</button>
        </div>
    </div>
    
    <!-- Configuration and utilities - load in proper order -->
    <script src="src/utils/Logger.js"></script>
    <script src="src/utils/URLParams.js"></script>
    <script src="src/utils/MathUtils.js"></script>
    <script src="src/utils/CollisionUtils.js"></script>
    <script src="src/systems/OptimizedParticlePool.js"></script>
    <script src="src/utils/ParticleHelpers.js"></script>
    <script src="src/systems/audio.js"></script>
    <script src="src/systems/performance.js"></script>
    <script src="src/systems/ResonanceSystem.js"></script>
    <script src="src/systems/IntelligentSpawner.js"></script>
    <script src="src/systems/EnemySpawner.js"></script>
    <script src="src/utils/debug.js"></script>
    
    <!-- Add error detection for script loading -->
    <script>
        window.scriptErrors = [];
        window.addEventListener('error', function(e) {
            if (e.filename && e.filename.includes && e.filename.includes('.js')) {
                console.error('Script error:', e.filename, e.message, e.lineno);
                window.scriptErrors.push({
                    file: e.filename,
                    message: e.message || 'Unknown error',
                    line: e.lineno || 0
                });
            }
        });
    </script>
    <!-- Diagnostic script -->
    <script src="diagnostic.js"></script>
    <!-- Core entities - load synchronously to ensure proper initialization order -->
    <script src="src/entities/particle.js"></script>
    <script src="src/entities/ShockwaveParticle.js"></script>
    <script src="src/entities/projectile.js"></script>
    <script src="src/entities/damageZone.js"></script>
    <script src="src/entities/EnemyProjectile.js"></script>
    <script src="src/entities/XPOrb.js"></script>
    <script src="src/entities/PlayerUpgrades.js"></script>
    <!-- Enemy components - if present (graceful: these files exist) -->
    <script src="src/entities/components/EnemyAI.js"></script>
    <script src="src/entities/components/EnemyAbilities.js"></script>
    <script src="src/entities/components/EnemyMovement.js"></script>
    <!-- Enemy class -->
    <script src="src/entities/enemy.js"></script>
    <!-- Remove phantom Player component tags (files not present) -->
    <!-- Player class -->
    <script src="src/entities/player.js"></script>
    <script src="src/systems/upgrades.js"></script>
    <script src="src/systems/achievements.js"></script>
    <script src="src/core/systems/UnifiedCollisionSystem.js"></script>
    <script src="src/core/systems/EntityManager.js"></script>
    <!-- Missing core systems - adding them -->
    <script src="src/core/systems/UIManager.js"></script>
    <script src="src/core/systems/StatsManager.js"></script>
    <script src="src/core/systems/DifficultyManager.js"></script>
    <script src="src/core/gameEngine.js"></script>
    <script src="src/core/systems/EffectsManager.js"></script>
    <script src="src/core/systems/FloatingTextSystem.js"></script>
    <script src="src/ui/uiEnhancements.js"></script>
    
    <!-- Script loading validation -->
    <script>
        (window.logger?.log || console.log)('All scripts loaded. Checking class availability...');
        (window.logger?.log || console.log)('Player class available:', typeof Player !== 'undefined');
        (window.logger?.log || console.log)('GameEngine class available:', typeof GameEngine !== 'undefined');
        (window.logger?.log || console.log)('Enemy class available:', typeof Enemy !== 'undefined');
        (window.logger?.log || console.log)('Projectile class available:', typeof Projectile !== 'undefined');
        
        if (typeof Player !== 'undefined') {
            try {
                // Test if Player can be instantiated
                let testPlayer = new Player(0, 0);
                (window.logger?.log || console.log)('Player instantiation test: SUCCESS');
                testPlayer = null; // cleanup
            } catch (e) {
                (window.logger?.error || console.error)('Player instantiation test: FAILED', e);
            }
        }
        
        // Set window reference for global access
        if (typeof Player !== 'undefined') window.Player = Player;
        if (typeof GameEngine !== 'undefined') window.GameEngine = GameEngine;
        if (typeof Enemy !== 'undefined') window.Enemy = Enemy;
        if (typeof Projectile !== 'undefined') window.Projectile = Projectile;
        if (typeof XPOrb !== 'undefined') window.XPOrb = XPOrb;
        if (typeof Particle !== 'undefined') window.Particle = Particle;
        
        (window.logger?.log || console.log)('Class references set on window object');
    </script>
    
    <!-- Load game constants first -->
    <script>
        // Inline GameConstants to avoid module loading issues
        const GAME_CONSTANTS = {
            // Player Configuration
            PLAYER: {
                BASE_SPEED: 220,
                BASE_HEALTH: 120,
                BASE_ATTACK_SPEED: 1.2,
                BASE_ATTACK_DAMAGE: 25,
                BASE_ATTACK_RANGE: 300,
                BASE_PROJECTILE_SPEED: 450,
                BASE_CRIT_CHANCE: 0.10,
                BASE_CRIT_MULTIPLIER: 2.2,
                BASE_MAGNET_RANGE: 120,
                
                // Dodge System
                DODGE_COOLDOWN: 2.0,
                DODGE_DURATION: 0.3,
                DODGE_SPEED: 600,
                INVULNERABILITY_TIME: 0.5,
                
                // XP System
                INITIAL_XP_TO_LEVEL: 212,
                XP_SCALING_FACTOR: 1.12,
                LEVEL_UP_HEAL_PERCENT: 0.3
            },
            
            // Enemy Configuration
            ENEMIES: {
                SPAWN_DISTANCE_MIN: 400,
                SPAWN_DISTANCE_MAX: 800,
                BASE_SPAWN_RATE: 1.1,
                BASE_MAX_ENEMIES: 50,
                ELITE_CHANCE_BASE: 0.06,
                ELITE_HEALTH_MULTIPLIER: 2.5,
                ELITE_DAMAGE_MULTIPLIER: 1.5,
                
                // Boss System
                BOSS_HEAL_BONUS: 0.15,
                BOSS_INVULNERABILITY_REWARD: 2.0
            },
            
            // Difficulty Scaling
            DIFFICULTY: {
                BASE_FACTOR: 1.0,
                MAX_FACTOR: 4.0,
                SCALING_INTERVAL: 20,
                SCALING_MULTIPLIER: 1.12,
                
                LOW_HEALTH_THRESHOLD: 0.3,
                LOW_HEALTH_SCALING_REDUCTION: 0.85,
                HIGH_LEVEL_THRESHOLD: 10,
                HIGH_LEVEL_SCALING_INCREASE: 1.05
            },
            
            // Game Modes
            GAME: {
                WIN_TIME: 180 // 3 minutes
            }
        };
        
        // Make globally available
        window.GAME_CONSTANTS = GAME_CONSTANTS;
        
        // GameMath helper functions
        const GameMath = {
            xpForLevel(level) {
                let totalXP = 0;
                let currentRequirement = GAME_CONSTANTS.PLAYER.INITIAL_XP_TO_LEVEL;
                
                for (let i = 1; i < level; i++) {
                    totalXP += currentRequirement;
                    currentRequirement = Math.floor(currentRequirement * GAME_CONSTANTS.PLAYER.XP_SCALING_FACTOR);
                }
                
                return totalXP;
            },
            
            scaledEnemyCount(baseCount, difficultyFactor, gameTime) {
                const timeMinutes = gameTime / 60;
                const timeFactor = 1 + (timeMinutes * 0.1);
                return Math.floor(baseCount * difficultyFactor * timeFactor);
            }
        };
        
        window.GameMath = GameMath;
        (window.logger?.log || console.log)('GameConstants loaded inline');
    </script>
    
    <!-- Initialize optimized particle pool -->
    <script>
        // Initialize optimized particle pool
        if (typeof OptimizedParticlePool !== 'undefined') {
            window.optimizedParticles = new OptimizedParticlePool(150);
            (window.logger?.log || console.log)('OptimizedParticlePool initialized');
        } else {
            (window.logger?.warn || console.warn)('OptimizedParticlePool not available');
        }
        
        // Initialize upgrade system if available
        if (typeof UpgradeSystem !== 'undefined') {
            window.upgradeSystem = new UpgradeSystem();
            (window.logger?.log || console.log)('UpgradeSystem initialized as global upgradeSystem');
        } else {
            (window.logger?.warn || console.warn)('UpgradeSystem not available');
        }
        
        // Initialize audio system if available
        if (typeof AudioSystem !== 'undefined') {
            window.audioSystem = new AudioSystem();
            (window.logger?.log || console.log)('AudioSystem initialized as global audioSystem');
        } else {
            (window.logger?.warn || console.warn)('AudioSystem not available');
        }
        
        // Initialize performance manager if available
        if (typeof PerformanceManager !== 'undefined') {
            window.performanceManager = new PerformanceManager();
            (window.logger?.log || console.log)('PerformanceManager initialized as global performanceManager');
        } else {
            (window.logger?.warn || console.warn)('PerformanceManager not available');
        }
    </script>
    
    <!-- Load GameManager Bridge for compatibility -->
    <script src="src/core/gameManagerBridge.js"></script>
    
    <script>
        // Initialize the game using the compatibility bridge
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                (window.logger?.log || console.log)('üåä DOM loaded, initializing game bridge...');
                
                // Wait for all scripts to load - check for core dependencies
                let attempts = 0;
                while (attempts < 10 && (typeof GameEngine === 'undefined' || typeof Player === 'undefined')) {
                    await new Promise(resolve => setTimeout(resolve, 50));
                    attempts++;
                }
                
                (window.logger?.log || console.log)('üîç Checking system availability...');
                
                // Check if all required systems are available
                const systemChecks = {
                    GameEngine: typeof window.GameEngine !== 'undefined',
                    EnemySpawner: typeof window.EnemySpawner !== 'undefined', 
                    Player: typeof window.Player !== 'undefined',
                    Projectile: typeof window.Projectile !== 'undefined',
                    Enemy: typeof window.Enemy !== 'undefined',
                    Particle: typeof window.Particle !== 'undefined'
                };
                
                (window.logger?.log || console.log)('üîç System availability:', systemChecks);
                
                // Report any missing systems
                const missingSystems = Object.entries(systemChecks)
                    .filter(([name, available]) => !available)
                    .map(([name]) => name);
                
                if (missingSystems.length > 0) {
                    (window.logger?.warn || console.warn)('‚ö†Ô∏è Missing systems:', missingSystems);
                } else {
                    (window.logger?.log || console.log)('‚úÖ All core systems available!');
                }
                
                // Initialize the game manager bridge
                (window.logger?.log || console.log)('üåä Creating GameManager bridge...');
                window.gameManager = new GameManagerBridge();
                // Also set global gameManager for backwards compatibility with entity code
                gameManager = window.gameManager;
                (window.logger?.log || console.log)('‚úÖ GameManager bridge created successfully');
                
                // Initialize supporting systems
                if (typeof UpgradeSystem !== 'undefined') {
                    window.upgradeSystem = new UpgradeSystem();
                    (window.logger?.log || console.log)('‚úÖ UpgradeSystem initialized');
                } else {
                    (window.logger?.warn || console.warn)('‚ö†Ô∏è UpgradeSystem not available');
                }
                
                if (typeof AudioSystem !== 'undefined') {
                    window.audioSystem = new AudioSystem();
                    (window.logger?.log || console.log)('‚úÖ AudioSystem initialized');
                } else {
                    (window.logger?.warn || console.warn)('‚ö†Ô∏è AudioSystem not available - creating stub');
                    window.audioSystem = {
                        play: () => {},
                        playBossBeat: () => {},
                        resumeAudioContext: () => {},
                        isMuted: false
                    };
                }
                // Also set global audioSystem for backwards compatibility with entity code
                audioSystem = window.audioSystem;
                
                if (typeof PerformanceManager !== 'undefined') {
                    window.performanceManager = new PerformanceManager();
                    (window.logger?.log || console.log)('‚úÖ PerformanceManager initialized');
                }
                
                if (typeof AchievementSystem !== 'undefined') {
                    window.achievementSystem = new AchievementSystem();
                    (window.logger?.log || console.log)('‚úÖ AchievementSystem initialized');
                } else {
                    (window.logger?.warn || console.warn)('‚ö†Ô∏è AchievementSystem not available - creating stub');
                    window.achievementSystem = {
                        achievements: {},
                        getUnlockedCount: () => 0,
                        getTotalCount: () => 0
                    };
                }
                
                (window.logger?.log || console.log)('üöÄ Starting main application...');
                initializeApp();
                
            } catch (error) {
                (window.logger?.error || console.error)('‚ùå Error initializing game systems:', error);
                alert('Failed to initialize game. Error: ' + error.message);
            }
        });
    </script>
    <script>
        // Initialize global systems after all scripts are loaded
        
        function initializeApp() {
            (window.logger?.log || console.log)('initializeApp called');
            const tips = [
                "Use WASD or Arrow Keys to move",
                "Enemies drop XP orbs when defeated",
                "Collect XP to level up and choose upgrades",
                "Press SPACE to dodge incoming enemies",
                "Bosses appear every 3 minutes",
                "Watch out for explosive enemies!",
                "Ranged enemies will shoot projectiles at you",
                "The game gets harder over time",
                "Piercing projectiles can hit multiple enemies",
                "Press P or ESC to pause the game",
                "The minimap shows nearby enemies and XP orbs"
            ];
            
            // Real asset loading progress tracking
            (window.logger?.log || console.log)('Setting up asset loading system');
            
            // Check if window is already loaded
            if (document.readyState === 'complete') {
                (window.logger?.log || console.log)('Window already loaded, starting asset loading');
                startAssetLoading();
            } else {
                window.addEventListener('load', () => {
                    (window.logger?.log || console.log)('Window loaded, starting asset loading');
                    startAssetLoading();
                });
            }
            
            function startAssetLoading() {
                // Display random tip
                const tipElem = document.getElementById('loading-tip');
                if (tipElem) {
                    tipElem.textContent = "Tip: " + tips[Math.floor(Math.random() * tips.length)];
                }
                
                const loadingBar = document.getElementById('loading-progress');
                
                // Track actual asset loading progress
                const assetChecks = [
                    () => typeof Player !== 'undefined',
                    () => typeof GameEngine !== 'undefined', 
                    () => typeof Enemy !== 'undefined',
                    () => typeof Projectile !== 'undefined',
                    () => typeof XPOrb !== 'undefined',
                    () => typeof Particle !== 'undefined',
                    () => typeof AudioSystem !== 'undefined',
                    () => typeof UpgradeSystem !== 'undefined',
                    () => typeof AchievementSystem !== 'undefined',
                    () => typeof PerformanceManager !== 'undefined'
                ];
                
                let loadedCount = 0;
                const totalAssets = assetChecks.length;
                
                (window.logger?.log || console.log)('Starting asset loading check loop');
                
                // Smooth loading animation using requestAnimationFrame
                function checkAssets() {
                    loadedCount = 0;
                    assetChecks.forEach(check => {
                        if (check()) loadedCount++;
                    });
                    
                    const progress = (loadedCount / totalAssets) * 100;
                    if (loadingBar) {
                        loadingBar.style.width = `${progress}%`;
                    }
                    
                    if (loadedCount < totalAssets) {
                        requestAnimationFrame(checkAssets);
                    } else {
                        (window.logger?.log || console.log)('All assets loaded, showing main menu');
                        setTimeout(() => {
                            (window.logger?.log || console.log)('Hiding loading screen');
                            const loadingScreen = document.getElementById('loading-screen');
                            if (loadingScreen) loadingScreen.classList.add('hidden');
                            const menu = document.getElementById('main-menu');
                            if (menu) menu.classList.remove('hidden');
                            (window.logger?.log || console.log)('Updating star display');
                            const starDisplay = document.getElementById('star-menu-display');
                            if (starDisplay && window.gameManager && window.gameManager.metaStars !== undefined) {
                                starDisplay.textContent = '‚≠ê ' + window.gameManager.metaStars;
                            }
                            (window.logger?.log || console.log)('Main menu ready');
                        }, 500);
                    }
                }
                
                // Start checking assets
                checkAssets();
            }
            
        // Button event handlers - moved inside initializeApp()
        const btnNormal = document.getElementById('btn-normal');
        if (btnNormal) {
            btnNormal.addEventListener('click', () => {
                (window.logger?.log || console.log)('üéÆ Starting Normal Mode...');
                const mainMenu = document.getElementById('main-menu');
                const gameContainer = document.getElementById('game-container');
                if (mainMenu) mainMenu.classList.add('hidden');
                if (gameContainer) gameContainer.classList.remove('hidden');
                if (window.gameManager) {
                    window.gameManager.endlessMode = false;
                    window.gameManager.startGame();
                }
            });
        }
        
        const btnEndless = document.getElementById('btn-endless');
        if (btnEndless) {
            btnEndless.addEventListener('click', () => {
                (window.logger?.log || console.log)('üéÆ Starting Endless Mode...');
                const mainMenu = document.getElementById('main-menu');
                const gameContainer = document.getElementById('game-container');
                if (mainMenu) mainMenu.classList.add('hidden');
                if (gameContainer) gameContainer.classList.remove('hidden');
                if (window.gameManager) {
                    window.gameManager.endlessMode = true;
                    window.gameManager.startGame();
                }
            });
        }
        
        // Settings button handler
        const btnSettings = document.getElementById('btn-settings');
        if (btnSettings) {
            btnSettings.addEventListener('click', () => {
                const panel = document.getElementById('settings-panel');
                if (!panel) return;
                // Populate current settings
                const muteCheckbox = document.getElementById('mute-checkbox');
                if (muteCheckbox && window.audioSystem) {
                    muteCheckbox.checked = window.audioSystem.isMuted;
                }
            // Safely initialize audio context if supported
            const audio = window.audioSystem;
            if (audio && typeof audio.initializeAudioContext === 'function' && !audio.masterGain) {
                audio.initializeAudioContext();
            }
            // Volume (load stored or current)
            const volumeEl = document.getElementById('volume-range');
            const storedVol = parseFloat(localStorage.getItem('volume'));
            if (!isNaN(storedVol) && volumeEl) {
                volumeEl.value = storedVol;
                if (audio && audio.masterGain && audio.masterGain.gain) {
                    audio.masterGain.gain.value = storedVol;
                }
            } else if (volumeEl) {
                volumeEl.value = (audio && audio.masterGain && audio.masterGain.gain)
                    ? audio.masterGain.gain.value : 0.5;
            }
            
            const lowQualityCheckbox = document.getElementById('lowquality-checkbox');
            const difficultySelect = document.getElementById('difficulty-select');
            if (lowQualityCheckbox && window.gameManager) {
                lowQualityCheckbox.checked = window.gameManager.lowQuality;
            }
            if (difficultySelect) {
                difficultySelect.value = localStorage.getItem('difficulty') || 'normal';
            }
            panel.classList.remove('hidden');
        });
        // Settings close/apply handler
        const settingsCloseBtn = document.getElementById('settings-close');
        if (settingsCloseBtn) {
            settingsCloseBtn.addEventListener('click', () => {
            // Mute
            const muteCheckbox = document.getElementById('mute-checkbox');
            const muted = muteCheckbox ? muteCheckbox.checked : false;
            if (window.audioSystem) window.audioSystem.isMuted = muted;
            localStorage.setItem('muted', muted);
            
            // Volume
            const volumeRange = document.getElementById('volume-range');
            const vol = volumeRange ? parseFloat(volumeRange.value) : 0.5;
            if (!isNaN(vol) && vol >= 0 && vol <= 1) {
                if (window.audioSystem && window.audioSystem.masterGain && window.audioSystem.masterGain.gain) {
                    window.audioSystem.masterGain.gain.value = vol;
                }
                localStorage.setItem('volume', vol.toString());
            }
            
            // Low Quality
            const lowQCheckbox = document.getElementById('lowquality-checkbox');
            const lowQ = lowQCheckbox ? lowQCheckbox.checked : false;
            if (window.gameManager) {
                window.gameManager.lowQuality = lowQ;
            }
            localStorage.setItem('lowQuality', lowQ);
            const minimap = document.getElementById('minimap-container');
            if (minimap) minimap.classList.toggle('hidden', lowQ);
            // Difficulty
            const difficultySelect = document.getElementById('difficulty-select');
            const diff = difficultySelect ? difficultySelect.value : 'normal';
            localStorage.setItem('difficulty', diff);
            let factor = 1.0;
            if (diff === 'easy') factor = 0.8;
            else if (diff === 'hard') factor = 1.2;
            if (window.gameManager) {
                window.gameManager.difficultyFactor = factor;
            }
            const settingsPanel = document.getElementById('settings-panel');
            if (settingsPanel) {
                settingsPanel.classList.add('hidden');
            }
        });
        
        // Apply stored settings immediately (no need for load event since we're already loaded)
        // Volume & mute
        const storedVol = parseFloat(localStorage.getItem('volume'));
        if (!isNaN(storedVol) && window.audioSystem && window.audioSystem.masterGain) {
            window.audioSystem.masterGain.gain.value = storedVol;
        }
        if (window.audioSystem) window.audioSystem.isMuted = localStorage.getItem('muted') === 'true';
            // Low Quality
            const storedLowQ = localStorage.getItem('lowQuality') === 'true';
            if (window.gameManager) {
                window.gameManager.lowQuality = storedLowQ;
            }
            const minimapCont = document.getElementById('minimap-container');
            if (minimapCont) minimapCont.classList.toggle('hidden', storedLowQ);
            // Difficulty
            const storedDiff = localStorage.getItem('difficulty') || 'normal';
            const factors = { easy: 0.8, normal: 1.0, hard: 1.2 };
            if (window.gameManager) {
                window.gameManager.difficultyFactor = factors[storedDiff] || 1.0;
            }
            
        // Star Vendor UI
        const metaUpgrades = [
            { id: 'mercury_speed', name: 'Mercury - Agile: +20 Move Speed', desc: 'Increase base movement speed by 20px', cost: 5, value: 20, maxTier: 2 },
            { id: 'mercury_dodge_cd', name: 'Mercury - Agile: -0.1s Dodge Cooldown', desc: 'Reduce dodge cooldown by 0.1s', cost: 5, value: 0.1, maxTier: 2 },
            { id: 'venus_hp', name: 'Venus - Fortified: +10 Max HP', desc: 'Increase maximum health by 10', cost: 5, value: 10, maxTier: 3 },
            { id: 'venus_regen', name: 'Venus - Fortified: +0.5 HP/sec Regen', desc: 'Increase health regeneration rate by 0.5 HP/s', cost: 5, value: 0.5, maxTier: 2 },
            { id: 'mars_damage', name: 'Mars - Warlike: +5% Attack Damage', desc: 'Increase base attack damage by 5%', cost: 5, value: 0.05, maxTier: 3 },
            { id: 'mars_attack_speed', name: 'Mars - Warlike: +0.05 Attacks/sec', desc: 'Increase attack speed by 0.05 attacks/sec', cost: 5, value: 0.05, maxTier: 2 },
            { id: 'jupiter_xp_gain', name: 'Jupiter - Prosperity: +5% XP Gain', desc: 'Increase XP gained by 5%', cost: 8, value: 0.05, maxTier: 2 },
            { id: 'jupiter_star_drop', name: 'Jupiter - Prosperity: Boss +1‚≠ê', desc: 'Bosses drop 1 extra star', cost: 15, value: 1, maxTier: 1 },
            { id: 'saturn_magnet', name: 'Saturn - Magnetism: +25px XP Magnet', desc: 'Increase XP orb magnet range by 25px', cost: 3, value: 25, maxTier: 3 },
            { id: 'saturn_extra_projectile', name: 'Saturn - Magnetism: +1 Projectile', desc: 'Unlock an extra projectile (spread shot)', cost: 10, value: 1, maxTier: 1 },
            { id: 'neptune_crit', name: 'Neptune - Stormbringer: +1% Crit Chance', desc: 'Increase critical hit chance by 1%', cost: 5, value: 0.01, maxTier: 3 },
            { id: 'neptune_aoe_boost', name: 'Neptune - Stormbringer: +10% AoE Damage', desc: 'Increase AoE damage multiplier by 10%', cost: 8, value: 0.1, maxTier: 1 },
            { id: 'pluto_damage_reduction', name: 'Pluto - Underworld: +5% Damage Reduction', desc: 'Reduce incoming damage by 5%', cost: 3, value: 0.05, maxTier: 2 },
            { id: 'pluto_start_level', name: 'Pluto - Underworld: +1 Starting Level', desc: 'Start each run at Level 2', cost: 10, value: 1, maxTier: 1 }
        ];
        
        // Shop event listeners - moved inside initializeApp()
        const shopBtn = document.getElementById('btn-shop');
        const shopCloseBtn = document.getElementById('shop-close');
        
        if (shopBtn) {
            shopBtn.addEventListener('click', renderShop);
        }
        if (shopCloseBtn) {
            shopCloseBtn.addEventListener('click', () => {
                const shopPanel = document.getElementById('shop-panel');
                if (shopPanel) {
                    shopPanel.classList.add('hidden');
                }
            });
        }
        
        function renderShop() {
            const panel = document.getElementById('shop-panel');
            if (!panel) return;
            
            // Update vendor star display
            const vendorDisplay = document.getElementById('vendor-star-display');
            if (vendorDisplay && window.gameManager) {
                vendorDisplay.textContent = '‚≠ê ' + window.gameManager.metaStars;
            }
            const items = document.getElementById('shop-items');
            items.innerHTML = '';
            metaUpgrades.forEach(u => {
                const key = 'meta_' + u.id;
                const current = parseInt(localStorage.getItem(key) || '0', 10);
                const tiered = u.maxTier > 1;
                const unlocked = tiered ? current >= u.maxTier : current > 0;
                const div = document.createElement('div');
                div.className = 'shop-item';
                const tierText = tiered ? ` <span class="tier-info">(${current}/${u.maxTier})</span>` : '';
                div.innerHTML = `<h3>${u.name}${tierText}</h3><p>${u.desc}</p><p>Cost: ${u.cost} ‚≠ê</p>`;
                const btn = document.createElement('button');
                btn.className = 'menu-button';
                btn.textContent = unlocked ? 'Maxed' : 'Buy';
                btn.disabled = unlocked || !window.gameManager || window.gameManager.metaStars < u.cost;
                btn.addEventListener('click', () => {
                    if (!unlocked && window.gameManager && window.gameManager.metaStars >= u.cost) {
                        // Deduct stars and update displays
                        window.gameManager.metaStars -= u.cost;
                        if (typeof window.gameManager.saveStarTokens === 'function') {
                            window.gameManager.saveStarTokens();
                        }
                        if (typeof window.gameManager.updateStarDisplay === 'function') {
                            window.gameManager.updateStarDisplay();
                        }
                        const menuStar = document.getElementById('star-menu-display');
                        if (menuStar && window.gameManager && window.gameManager.metaStars !== undefined) {
                            menuStar.textContent = '‚≠ê ' + window.gameManager.metaStars;
                        }
                        // Update vendor panel star count
                        if (vendorDisplay && window.gameManager && window.gameManager.metaStars !== undefined) {
                            vendorDisplay.textContent = '‚≠ê ' + window.gameManager.metaStars;
                        }
                        if (tiered) {
                            const newTier = current + 1;
                            localStorage.setItem(key, newTier.toString());
                            // Check if upgrade is now maxed
                            if (newTier >= u.maxTier) {
                                if (typeof window.gameManager.onUpgradeMaxed === 'function') {
                                    window.gameManager.onUpgradeMaxed(u.id);
                                }
                            }
                        } else {
                            localStorage.setItem(key, '1');
                            // Single-tier upgrades are maxed immediately
                            if (typeof window.gameManager.onUpgradeMaxed === 'function') {
                                window.gameManager.onUpgradeMaxed(u.id);
                            }
                        }
                        renderShop();
                    }
                });
                div.appendChild(btn);
                items.appendChild(div);
            });
            panel.classList.remove('hidden');
        }
        
        // Add achievements button handler
        const achBtn = document.getElementById('btn-achievements');
        if (achBtn) achBtn.addEventListener('click', () => {
            const panel = document.getElementById('achievements-panel');
            const list = document.getElementById('achievements-list');
            const count = document.getElementById('achievements-count');
            if (!panel || !list || !count || !window.achievementSystem) return;
            
            // Update achievements count
            count.textContent = `${window.achievementSystem.getUnlockedCount()}/${window.achievementSystem.getTotalCount()}`;
            
            // Clear and rebuild achievements list
            list.innerHTML = '';
            Object.entries(window.achievementSystem.achievements || {}).forEach(([key, achievement]) => {
                const div = document.createElement('div');
                div.className = `achievement-item ${achievement.unlocked ? 'unlocked' : 'locked'}`;
                div.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-info">
                        <h3>${achievement.name}</h3>
                        <p>${achievement.description}</p>
                        <div class="achievement-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${achievement.target ? (achievement.progress / achievement.target) * 100 : 0}%"></div>
                            </div>
                            <span>${achievement.progress}/${achievement.target}</span>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
            
            panel.classList.remove('hidden');
        });
        
        // Add achievements close handler
        const achClose = document.getElementById('achievements-close');
        if (achClose) achClose.addEventListener('click', () => {
            const panel = document.getElementById('achievements-panel');
            if (panel) panel.classList.add('hidden');
        });
        
        } // End of initializeApp function
    </script>
</body>
</html>
