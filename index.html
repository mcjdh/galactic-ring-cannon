<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A 2D survival game">
    <meta name="author" content="mcjdh">
    <meta name="theme-color" content="#111111">
    <title>Galactic Ring Cannon</title>
    <link rel="preload" href="assets/css/styles.css" as="style">
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÆ</text></svg>">
</head>
<body>
    <div id="loading-screen">
        <h1>Galactic Ring Cannon</h1>
        <p>Prepare for battle...</p>
        <div id="loading-bar">
            <div id="loading-progress"></div>
        </div>
        <p id="loading-tip">Tip: Use WASD or Arrow Keys to move</p>
    </div>
    
    <!-- Main Menu: Title / Mode Selection -->
    <div id="main-menu" class="hidden">
        <h1 id="menu-title">Galactic Ring Cannon</h1>
        <div id="star-menu-display">‚≠ê 0</div>
        <p id="menu-subtitle">Select Mode:</p>
        <button id="btn-normal" class="menu-button">Normal Mode</button>
        <button id="btn-endless" class="menu-button">Endless Mode</button>
        <button id="btn-settings" class="menu-button">Settings</button>
        <button id="btn-shop" class="menu-button">Star Vendor</button>
        <button id="btn-achievements" class="menu-button">Achievements</button>
    </div>
    
    <div id="game-container" class="hidden">
        <canvas id="game-canvas"></canvas>
        <div id="level-up-container" class="hidden">
            <h2>Level Up!</h2>
            <p class="shortcut-hint">Press 1, 2, or 3 to select an upgrade</p>
            <div id="upgrade-options"></div>
        </div>
        <!-- Timer display at top center -->
        <div id="timer-container">
            <div id="timer-display">00:00</div>
            <div id="boss-countdown" class="hidden">Next boss: 1m 0s</div>
        </div>

        <div id="ui-container">
            <div id="health-bar"></div>
            <div id="xp-bar"></div>
            <div id="level-display">Level: 1</div>
            <!-- Combo progress bar -->
            <div id="combo-container">
                <div id="combo-fill"></div>
            </div>
            <!-- Combo count display -->
            <div id="combo-text">0</div>
        </div>
        <button id="pause-button" class="control-button">‚è∏Ô∏è</button>
        <div id="controls-info">P or ESC = Pause | SPACE = Dodge</div>
        
        <!-- Add minimap -->
        <div id="minimap-container">
            <canvas id="minimap"></canvas>
        </div>
        
        <!-- Add skill cooldown indicator -->
        <div id="skill-container">
            <div id="dodge-skill" class="skill">
                <div class="skill-icon">üí®</div>
                <div class="skill-cooldown"></div>
                <div class="skill-key">SPACE</div>
            </div>
        </div>
    </div>
    
    <div id="pause-menu" class="hidden">
        <div class="pause-content">
            <h2>Game Paused</h2>
        <button id="resume-button" class="menu-button">Resume</button>
        <button id="restart-button-pause" class="menu-button">Restart</button>
        <button id="return-button-pause" class="menu-button">Main Menu</button>
            <h3>Controls:</h3>
            <p>WASD or Arrow Keys = Move</p>
            <p>P or ESC = Pause Game</p>
        <p>M = Toggle Sound</p>
        <p>L = Toggle Low Quality</p>
        </div>
    </div>

    <div id="result-screen" class="hidden">
        <div class="settings-content">
            <h2 id="result-title">Run Complete</h2>
            <p id="result-subtitle"></p>
            <div id="result-stats"></div>
            <div id="result-buttons" class="result-buttons"></div>
        </div>
    </div>
    
    <!-- Shop Panel -->
    <div id="shop-panel" class="hidden">
        <div class="settings-content">
            <h2>Star Vendor</h2>
            <!-- Show current star balance -->
            <div id="vendor-star-display">‚≠ê 0</div>
            <!-- List of purchasable upgrades -->
            <div id="shop-items"></div>
            <button id="shop-close" class="menu-button">Close</button>
        </div>
    </div>
    <!-- Settings Panel -->
    <div id="settings-panel" class="hidden">
        <div class="settings-content">
            <h2>Settings</h2>
            <div class="setting-item">
                <label for="mute-checkbox">Mute</label>
                <input type="checkbox" id="mute-checkbox">
            </div>
            <div class="setting-item">
                <label for="volume-range">Volume</label>
                <input type="range" id="volume-range" min="0" max="1" step="0.01">
            </div>
            <div class="setting-item">
                <label for="lowquality-checkbox">Low Quality</label>
                <input type="checkbox" id="lowquality-checkbox">
            </div>
            <div class="setting-item">
                <label for="difficulty-select">Difficulty</label>
                <select id="difficulty-select">
                    <option value="easy">Easy</option>
                    <option value="normal">Normal</option>
                    <option value="hard">Hard</option>
                </select>
            </div>
            <button id="settings-close" class="menu-button">Apply & Close</button>
        </div>
    </div>
    
    <!-- Add Achievements Panel -->
    <div id="achievements-panel" class="hidden">
        <div class="settings-content">
            <h2>Achievements</h2>
            <div id="achievements-progress">
                <span id="achievements-count">0/0</span> Achievements Unlocked
            </div>
            <div id="achievements-list"></div>
            <button id="achievements-close" class="menu-button">Close</button>
        </div>
    </div>
    
    <!-- Configuration files - load FIRST before systems that depend on them -->
    <script src="src/config/upgrades.config.js"></script>
    <script src="src/config/achievements.config.js"></script>
    <script src="src/config/metaUpgrades.config.js"></script>

    <!-- Configuration and utilities - load in proper order -->
    <script src="src/utils/Logger.js"></script>
    <script src="src/utils/URLParams.js"></script>
    <script src="src/utils/MathUtils.js"></script>
    <script src="src/utils/CollisionUtils.js"></script>
    <script src="src/systems/OptimizedParticlePool.js"></script>
    <script src="src/systems/InputManager.js"></script>
    <script src="src/utils/ParticleHelpers.js"></script>
    <script src="src/systems/audio.js"></script>
    <script src="src/systems/performance.js"></script>
    <script src="src/systems/EnemySpawner.js"></script>
    <script src="src/utils/debug.js"></script>
    <script src="debug-projectiles.js"></script>
    <!-- Dev utilities moved to conditional loader above -->
    
    <!-- Add error detection for script loading -->
    <script>
        window.scriptErrors = [];
        window.addEventListener('error', function(e) {
            if (e.filename && e.filename.includes && e.filename.includes('.js')) {
                console.error('Script error:', e.filename, e.message, e.lineno);
                window.scriptErrors.push({
                    file: e.filename,
                    message: e.message || 'Unknown error',
                    line: e.lineno || 0
                });
            }
        });
    </script>

    <script>
        (function() {
            const screen = {
                root: document.getElementById('result-screen'),
                title: document.getElementById('result-title'),
                subtitle: document.getElementById('result-subtitle'),
                stats: document.getElementById('result-stats'),
                buttonsContainer: document.getElementById('result-buttons')
            };

            function defaultRestart() {
                if (window.gameManager?.startGame) {
                    window.gameManager.startGame();
                } else if (window.gameManagerBridge?.startGame) {
                    window.gameManagerBridge.resetGameState?.();
                    window.gameManagerBridge.startGame();
                }
            }

            function defaultMenu() {
                if (window.gameManager?.returnToMenu) {
                    window.gameManager.returnToMenu();
                } else if (window.gameManagerBridge?.returnToMenu) {
                    window.gameManagerBridge.returnToMenu();
                } else {
                    const gameContainer = document.getElementById('game-container');
                    const mainMenu = document.getElementById('main-menu');
                    if (gameContainer) gameContainer.classList.add('hidden');
                    if (mainMenu) mainMenu.classList.remove('hidden');
                }
            }

            function hide() {
                if (screen.root) {
                    screen.root.classList.add('hidden');
                    screen.root.removeAttribute('data-outcome');
                }
                if (screen.stats) {
                    screen.stats.innerHTML = '';
                }
                if (screen.buttonsContainer) {
                    screen.buttonsContainer.innerHTML = '';
                }
            }

            function normalizeButtons(buttons) {
                if (!Array.isArray(buttons) || buttons.length === 0) {
                    return [
                        { label: 'Restart', action: defaultRestart },
                        { label: 'Main Menu', action: defaultMenu }
                    ];
                }
                return buttons.map(button => ({
                    label: button?.label ?? 'Action',
                    action: typeof button?.action === 'function' ? button.action : () => {}
                }));
            }

            function renderButtons(buttons) {
                if (!screen.buttonsContainer) return;
                screen.buttonsContainer.innerHTML = '';
                normalizeButtons(buttons).forEach(button => {
                    const btn = document.createElement('button');
                    btn.className = 'menu-button';
                    btn.textContent = button.label;
                    btn.addEventListener('click', () => {
                        hide();
                        try {
                            button.action();
                        } catch (error) {
                            console.error('Result button handler error:', error);
                        }
                    });
                    screen.buttonsContainer.appendChild(btn);
                });
            }

            function show(options = {}) {
                if (!screen.root) return;
                const {
                    title = 'Run Complete',
                    subtitle = '',
                    stats = [],
                    outcome = 'summary',
                    buttons = []
                } = options;

                screen.root.setAttribute('data-outcome', outcome);

                if (screen.title) screen.title.textContent = title;
                if (screen.subtitle) {
                    if (subtitle) {
                        screen.subtitle.textContent = subtitle;
                        screen.subtitle.style.display = '';
                    } else {
                        screen.subtitle.textContent = '';
                        screen.subtitle.style.display = 'none';
                    }
                }

                if (screen.stats) {
                    screen.stats.innerHTML = '';
                    if (Array.isArray(stats) && stats.length > 0) {
                        const list = document.createElement('ul');
                        list.className = 'result-stats-list';
                        stats.forEach(({ label, value }) => {
                            const item = document.createElement('li');
                            item.textContent = `${label}: ${value}`;
                            list.appendChild(item);
                        });
                        screen.stats.appendChild(list);
                    }
                }

                renderButtons(buttons);
                screen.root.classList.remove('hidden');
            }

            window.resultScreen = { show, hide };
        })();
    </script>
    <!-- Core entities - load synchronously to ensure proper initialization order -->
    <script src="src/entities/particle.js"></script>
    <script src="src/entities/ShockwaveParticle.js"></script>
    <!-- Projectile system - modular behavior-based architecture -->
    <script src="src/entities/projectile/behaviors/BehaviorBase.js"></script>
    <script src="src/entities/projectile/behaviors/BehaviorManager.js"></script>
    <script src="src/entities/projectile/behaviors/PiercingBehavior.js"></script>
    <script src="src/entities/projectile/behaviors/RicochetBehavior.js"></script>
    <script src="src/entities/projectile/behaviors/ExplosiveBehavior.js"></script>
    <script src="src/entities/projectile/behaviors/ChainBehavior.js"></script>
    <script src="src/entities/projectile/behaviors/HomingBehavior.js"></script>
    <script src="src/entities/projectile/ProjectileRenderer.js"></script>
    <script src="src/entities/projectile/Projectile.js"></script>
    <script src="src/entities/projectile/ProjectileFactory.js"></script>
    <script src="src/entities/damageZone.js"></script>
    <script src="src/entities/EnemyProjectile.js"></script>
    <script src="src/entities/XPOrb.js"></script>
    <script src="src/entities/PlayerUpgrades.js"></script>
    <!-- Enemy components - shared behavior systems -->
    <script src="src/entities/components/EnemyAI.js"></script>
    <script src="src/entities/components/EnemyAbilities.js"></script>
    <script src="src/entities/components/EnemyMovement.js"></script>
    <!-- Enemy system - modular type-based architecture -->
    <script src="src/entities/enemy/types/EnemyTypeBase.js"></script>
    <script src="src/entities/enemy/types/BasicEnemy.js"></script>
    <script src="src/entities/enemy/types/FastEnemy.js"></script>
    <script src="src/entities/enemy/types/TankEnemy.js"></script>
    <script src="src/entities/enemy/types/RangedEnemy.js"></script>
    <script src="src/entities/enemy/types/DasherEnemy.js"></script>
    <script src="src/entities/enemy/types/ExploderEnemy.js"></script>
    <script src="src/entities/enemy/types/TeleporterEnemy.js"></script>
    <script src="src/entities/enemy/types/PhantomEnemy.js"></script>
    <script src="src/entities/enemy/types/ShielderEnemy.js"></script>
    <script src="src/entities/enemy/types/BossEnemy.js"></script>
    <script src="src/entities/enemy/EnemyTypeRegistry.js"></script>
    <script src="src/entities/enemy/EnemyStats.js"></script>
    <script src="src/entities/enemy/EnemyRenderer.js"></script>
    <script src="src/entities/enemy/Enemy.js"></script>
    <!-- Player modular components -->
    <script src="src/entities/player/PlayerStats.js"></script>
    <script src="src/entities/player/PlayerMovement.js"></script>
    <script src="src/entities/player/PlayerCombat.js"></script>
    <script src="src/entities/player/PlayerAbilities.js"></script>
    <script src="src/entities/player/PlayerRenderer.js"></script>
    <!-- Player coordinator class -->
    <script src="src/entities/player/Player.js"></script>
    <script src="src/systems/upgrades.js"></script>
    <script src="src/systems/achievements.js"></script>
    <!-- üåä GAME STATE - Single Source of Truth (load first!) -->
    <script src="src/core/GameState.js"></script>
    <script src="src/core/GameState.test.js"></script>
    <script src="src/core/systems/CollisionSystem.js"></script>
    <script src="src/core/systems/EntityManager.js"></script>
    <script src="src/core/systems/StatsManager.js"></script>
    <script src="src/core/systems/DifficultyManager.js"></script>
    <script src="src/core/systems/UnifiedUIManager.js"></script>
    <script src="src/core/systems/MinimapSystem.js"></script>
    <script src="src/core/gameEngine.js"></script>
    <script src="src/core/systems/EffectsManager.js"></script>
    <script src="src/core/systems/FloatingTextSystem.js"></script>
    
    <!-- Script loading validation -->
    <script>
        (window.logger?.log || console.log)('All scripts loaded. Checking class availability...');
        (window.logger?.log || console.log)('Player class available:', typeof Player !== 'undefined');
        (window.logger?.log || console.log)('GameEngine class available:', typeof GameEngine !== 'undefined');
        (window.logger?.log || console.log)('Enemy class available:', typeof Enemy !== 'undefined');
        (window.logger?.log || console.log)('Projectile class available:', typeof Projectile !== 'undefined');
        
        if (typeof Player !== 'undefined') {
            try {
                // Test if Player can be instantiated
                let testPlayer = new Player(0, 0);
                (window.logger?.log || console.log)('Player instantiation test: SUCCESS');
                testPlayer = null; // cleanup
            } catch (e) {
                (window.logger?.error || console.error)('Player instantiation test: FAILED', e);
            }
        }
        
        // Set window reference for global access
        if (typeof Player !== 'undefined') window.Player = Player;
        if (typeof GameEngine !== 'undefined') window.GameEngine = GameEngine;
        if (typeof Enemy !== 'undefined') window.Enemy = Enemy;
        if (typeof Projectile !== 'undefined') window.Projectile = Projectile;
        if (typeof XPOrb !== 'undefined') window.XPOrb = XPOrb;
        if (typeof Particle !== 'undefined') window.Particle = Particle;
        
        (window.logger?.log || console.log)('Class references set on window object');
    </script>
    
    <!-- Load game constants first -->
    <script>
        // Inline GameConstants to avoid module loading issues
        const GAME_CONSTANTS = {
            // Player Configuration
            PLAYER: {
                BASE_SPEED: 220,
                BASE_HEALTH: 120,
                BASE_ATTACK_SPEED: 1.2,
                BASE_ATTACK_DAMAGE: 25,
                BASE_ATTACK_RANGE: 300,
                BASE_PROJECTILE_SPEED: 450,
                BASE_CRIT_CHANCE: 0.10,
                BASE_CRIT_MULTIPLIER: 2.2,
                BASE_MAGNET_RANGE: 120,
                
                // Dodge System
                DODGE_COOLDOWN: 2.0,
                DODGE_DURATION: 0.3,
                DODGE_SPEED: 600,
                INVULNERABILITY_TIME: 0.5,
                
                // XP System (early-game friendlier)
                INITIAL_XP_TO_LEVEL: 140,
                XP_SCALING_FACTOR: 1.12, // fallback; see LEVELING for piecewise
                LEVEL_UP_HEAL_PERCENT: 0.3,
                LEVELING: {
                    EARLY_LEVELS: 7,
                    EARLY_MULTIPLIER: 1.08,
                    MID_LEVELS: 15,
                    MID_MULTIPLIER: 1.11,
                    LATE_MULTIPLIER: 1.12,
                    EARLY_XP_BOOST_DURATION: 60, // seconds
                    EARLY_XP_BOOST_MULTIPLIER: 1.5
                }
            },
            
            // Enemy Configuration
            ENEMIES: {
                SPAWN_DISTANCE_MIN: 400,
                SPAWN_DISTANCE_MAX: 800,
                BASE_SPAWN_RATE: 1.1,
                BASE_MAX_ENEMIES: 50,
                ELITE_CHANCE_BASE: 0.06,
                ELITE_HEALTH_MULTIPLIER: 2.5,
                ELITE_DAMAGE_MULTIPLIER: 1.5,
                
                // Boss System
                BOSS_HEAL_BONUS: 0.15,
                BOSS_INVULNERABILITY_REWARD: 2.0
            },
            
            // Difficulty Scaling
            DIFFICULTY: {
                BASE_FACTOR: 1.0,
                MAX_FACTOR: 4.0,
                SCALING_INTERVAL: 20,
                SCALING_MULTIPLIER: 1.12,
                
                LOW_HEALTH_THRESHOLD: 0.3,
                LOW_HEALTH_SCALING_REDUCTION: 0.85,
                HIGH_LEVEL_THRESHOLD: 10,
                HIGH_LEVEL_SCALING_INCREASE: 1.05
            },
            
            // Game Modes
            GAME: {
                WIN_TIME: 180 // 3 minutes
            }
        };
        
        // Make globally available
        window.GAME_CONSTANTS = GAME_CONSTANTS;
        
        // GameMath helper functions
        const GameMath = {
            xpForLevel(level) {
                const LV = GAME_CONSTANTS.PLAYER.LEVELING || {};
                const earlyLevels = LV.EARLY_LEVELS ?? 7;
                const midLevels = LV.MID_LEVELS ?? 15;
                const earlyMult = LV.EARLY_MULTIPLIER ?? 1.08;
                const midMult = LV.MID_MULTIPLIER ?? 1.11;
                const lateMult = LV.LATE_MULTIPLIER ?? GAME_CONSTANTS.PLAYER.XP_SCALING_FACTOR;
                let totalXP = 0;
                let currentRequirement = GAME_CONSTANTS.PLAYER.INITIAL_XP_TO_LEVEL;
                for (let i = 1; i < level; i++) {
                    totalXP += currentRequirement;
                    const next = i + 1;
                    if (next <= earlyLevels) {
                        currentRequirement = Math.floor(currentRequirement * earlyMult);
                    } else if (next <= midLevels) {
                        currentRequirement = Math.floor(currentRequirement * midMult);
                    } else {
                        currentRequirement = Math.floor(currentRequirement * lateMult);
                    }
                }
                return totalXP;
            },
            
            scaledEnemyCount(baseCount, difficultyFactor, gameTime) {
                const timeMinutes = gameTime / 60;
                const timeFactor = 1 + (timeMinutes * 0.1);
                return Math.floor(baseCount * difficultyFactor * timeFactor);
            },

            earlyXPBoostMultiplier(gameTime) {
                const LV = GAME_CONSTANTS.PLAYER.LEVELING || {};
                const duration = LV.EARLY_XP_BOOST_DURATION ?? 0;
                const mult = LV.EARLY_XP_BOOST_MULTIPLIER ?? 1.0;
                if (duration <= 0) return 1.0;
                if (gameTime <= duration) return mult;
                // Ease-out from boost to 1.0 over next 30s
                const t = Math.min(1, (gameTime - duration) / 30);
                return mult - (mult - 1.0) * t;
            }
        };
        
        window.GameMath = GameMath;
        (window.logger?.log || console.log)('GameConstants loaded inline');
    </script>
    
    <!-- Initialize optimized particle pool -->
    <script>
        // Initialize optimized particle pool
        if (typeof OptimizedParticlePool !== 'undefined') {
            window.optimizedParticles = new OptimizedParticlePool(150);
            (window.logger?.log || console.log)('OptimizedParticlePool initialized');
        } else {
            (window.logger?.warn || console.warn)('OptimizedParticlePool not available');
        }
        
        // Initialize systems that are safe to initialize early (no duplicates)
        // These will be checked again in DOMContentLoaded if they fail here
    </script>
    
    <!-- Load GameManager Bridge only (GameManager class not required at runtime) -->
    <script src="src/core/gameManagerBridge.js"></script>
    
    <script src="src/core/bootstrap.js"></script>
</body>
</html>
